document.addEventListener("DOMContentLoaded", async () => {
    const select = document.getElementById("elegir-cine");
    const cartelera = document.getElementById("cartelera");

    if (!select || !cartelera) return;

    const urlCines = select.dataset.url;
    const cineGuardado = localStorage.getItem("cineSeleccionado") || "";

    let cines = [];
    let peliculas = [];

    // Cargar cines
    try {
        const res = await fetch(urlCines);
        const datos = await res.json();

        if (datos.cines) {
            cines = datos.cines;
            select.innerHTML = '<option value=""> - Elige tu cine favorito - </option>';

            cines.forEach(cine => {
                const option = document.createElement("option");
                option.value = cine.id_cine;
                option.textContent = cine.nombre;
                if (cineGuardado == cine.id_cine) option.selected = true;
                select.appendChild(option);
            });

            // Mostrar cartelera inicial
            await cargarCartelera(cineGuardado);
        }
    } catch (err) {
        console.error("Error cargando cines:", err);
    }

    // Escuchar cambios
    select.addEventListener("change", async () => {
        const id = select.value;
        if (id) {
            localStorage.setItem("cineSeleccionado", id);
        } else {
            localStorage.removeItem("cineSeleccionado");
        }
        await cargarCartelera(id);
    });

    async function cargarCartelera(idCine = "") {
        try {
            let url = "/Proyecto-Nostromo/servicios_rest/peliculas";
            if (idCine) url += `?id_cine=${idCine}`;

            const res = await fetch(url);
            const datos = await res.json();

            peliculas = datos.peliculas || [];

            renderizarCartelera(peliculas);
        } catch (error) {
            console.error("Error al cargar cartelera:", error);
            cartelera.innerHTML = "<p>Error al cargar la cartelera.</p>";
        }
    }

    function generarURLCompra(idPelicula) {
        const idCine = localStorage.getItem("cineSeleccionado");
    
        const baseUrl = "/Proyecto-Nostromo/app/index.php?vista=seleccion_sesion";
        const params = new URLSearchParams();
        params.append("id_pelicula", idPelicula);
        
        if (idCine) {
            params.append("id_cine", idCine);
        }
    
        return `${baseUrl}&${params.toString()}`;
    }
    
    

    function renderizarCartelera(lista) {
        if (!lista.length) {
            cartelera.innerHTML = "<p>No hay pel√≠culas para mostrar.</p>";
            return;
        }

        cartelera.innerHTML = lista.map(p => `
            <div class="cont-pelicula">
            <div class="tarjeta">
            <picture>
                <source media="(min-width: 1024px)"
                        srcset="https://nostromo-media.s3.eu-north-1.amazonaws.com/carteleras/${p.foto}-desktop.png">
                <source media="(min-width: 768px)"
                        srcset="https://nostromo-media.s3.eu-north-1.amazonaws.com/carteleras/${p.foto}-tablet.png">
                <img class="foto-cartelera"
                    src="https://nostromo-media.s3.eu-north-1.amazonaws.com/carteleras/${p.foto}-mobile.png"
                    alt="foto-cartelera">
            </picture>
                <p class="cartel-titulo">${p.titulo}</p>
                <p class="cartel-sinopsis">${p.sinopsis}</p>
                </div>
                <p class="logo-boton">
                    <a href="${generarURLCompra(p.id_pelicula)}">
                        <span class="svg-default">
                            <svg width="159" height="43" viewBox="0 0 159 43" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="2" y="2" width="155" height="39" fill="#213140" stroke="#E6EB6C" stroke-width="4"/>
                            <path d="M23.111 28.288C22.055 28.288 21.125 28.051 20.321 27.577C19.523 27.103 18.899 26.398 18.449 25.462C17.999 24.526 17.774 23.365 17.774 21.979C17.774 20.587 17.996 19.423 18.44 18.487C18.89 17.551 19.517 16.846 20.321 16.372C21.125 15.892 22.055 15.652 23.111 15.652C24.635 15.652 25.796 16.012 26.594 16.732C27.392 17.452 27.866 18.385 28.016 19.531L24.956 20.062C24.818 19.546 24.599 19.12 24.299 18.784C24.005 18.442 23.609 18.271 23.111 18.271C22.667 18.271 22.274 18.406 21.932 18.676C21.596 18.94 21.335 19.345 21.149 19.891C20.963 20.437 20.87 21.133 20.87 21.979C20.87 22.807 20.966 23.494 21.158 24.04C21.35 24.58 21.614 24.982 21.95 25.246C22.292 25.51 22.679 25.642 23.111 25.642C23.729 25.642 24.191 25.48 24.497 25.156C24.803 24.826 24.956 24.427 24.956 23.959H27.998C27.998 24.889 27.809 25.678 27.431 26.326C27.059 26.968 26.51 27.457 25.784 27.793C25.058 28.123 24.167 28.288 23.111 28.288ZM35.2749 28.288C34.1289 28.288 33.1269 28.048 32.2689 27.568C31.4169 27.082 30.7539 26.368 30.2799 25.426C29.8059 24.478 29.5689 23.311 29.5689 21.925C29.5689 20.503 29.8059 19.33 30.2799 18.406C30.7539 17.476 31.4169 16.786 32.2689 16.336C33.1269 15.88 34.1289 15.652 35.2749 15.652C36.4329 15.652 37.4409 15.889 38.2989 16.363C39.1629 16.837 39.8319 17.539 40.3059 18.469C40.7799 19.399 41.0169 20.551 41.0169 21.925C41.0169 23.335 40.7799 24.514 40.3059 25.462C39.8319 26.404 39.1629 27.112 38.2989 27.586C37.4409 28.054 36.4329 28.288 35.2749 28.288ZM35.2749 25.705C36.1149 25.705 36.7869 25.375 37.2909 24.715C37.7949 24.049 38.0469 23.113 38.0469 21.907C38.0469 20.773 37.7949 19.879 37.2909 19.225C36.7869 18.565 36.1149 18.235 35.2749 18.235C34.4589 18.235 33.7989 18.565 33.2949 19.225C32.7909 19.879 32.5389 20.779 32.5389 21.925C32.5389 23.119 32.7909 24.049 33.2949 24.715C33.7989 25.375 34.4589 25.705 35.2749 25.705ZM43.3062 15.922H47.4282L50.1012 22.366H49.8762L52.5492 15.922H56.5092V28H53.6112V19.405H54.0072L50.9022 26.875H49.0392L45.9522 19.423H46.1862V28H43.3062V15.922ZM59.4939 28V15.922H64.1289C65.5209 15.922 66.6249 16.258 67.4409 16.93C68.2569 17.596 68.6649 18.583 68.6649 19.891C68.6649 21.193 68.2569 22.183 67.4409 22.861C66.6249 23.533 65.5209 23.869 64.1289 23.869H62.3919V28H59.4939ZM62.3919 21.349H64.1289C64.6509 21.349 65.0439 21.205 65.3079 20.917C65.5779 20.623 65.7129 20.281 65.7129 19.891C65.7129 19.495 65.5779 19.15 65.3079 18.856C65.0439 18.562 64.6509 18.415 64.1289 18.415H62.3919V21.349ZM70.5347 28V15.922H75.2507C76.7627 15.922 77.9357 16.27 78.7697 16.966C79.6097 17.656 80.0297 18.583 80.0297 19.747C80.0297 20.887 79.6097 21.802 78.7697 22.492C77.9357 23.176 76.7627 23.518 75.2507 23.518H73.4147V28H70.5347ZM76.8347 28L73.8917 22.168H76.9337L80.6057 28H76.8347ZM73.4147 21.646H74.9267C75.6407 21.646 76.1747 21.499 76.5287 21.205C76.8887 20.905 77.0687 20.524 77.0687 20.062C77.0687 19.582 76.9157 19.189 76.6097 18.883C76.3097 18.571 75.8567 18.415 75.2507 18.415H73.4147V21.646ZM81.5017 28L85.5697 15.922H89.2327L93.0757 28H90.0427L89.3857 25.876H85.2187L84.5617 28H81.5017ZM85.9477 23.743H88.7287L87.3607 19.324L85.9477 23.743ZM94.9155 28V15.922H99.6315C101.144 15.922 102.317 16.27 103.151 16.966C103.991 17.656 104.411 18.583 104.411 19.747C104.411 20.887 103.991 21.802 103.151 22.492C102.317 23.176 101.144 23.518 99.6315 23.518H97.7955V28H94.9155ZM101.216 28L98.2725 22.168H101.315L104.987 28H101.216ZM97.7955 21.646H99.3075C100.022 21.646 100.556 21.499 100.91 21.205C101.27 20.905 101.45 20.524 101.45 20.062C101.45 19.582 101.297 19.189 100.991 18.883C100.691 18.571 100.238 18.415 99.6315 18.415H97.7955V21.646Z" fill="#E6EB6C"/>
                            <path d="M136 15H118C117.735 15 117.48 15.1054 117.293 15.2929C117.105 15.4804 117 15.7348 117 16V20H117.893C118.889 20 119.813 20.681 119.973 21.664C120.022 21.951 120.007 22.2453 119.931 22.5261C119.854 22.807 119.717 23.0677 119.529 23.2902C119.341 23.5126 119.107 23.6913 118.843 23.8139C118.579 23.9365 118.291 24 118 24H117V28C117 28.2652 117.105 28.5196 117.293 28.7071C117.48 28.8946 117.735 29 118 29H136C136.265 29 136.52 28.8946 136.707 28.7071C136.895 28.5196 137 28.2652 137 28V24H136C135.709 24 135.421 23.9365 135.157 23.8139C134.893 23.6913 134.659 23.5126 134.471 23.2902C134.283 23.0677 134.146 22.807 134.069 22.5261C133.993 22.2453 133.978 21.951 134.027 21.664C134.187 20.681 135.111 20 136.107 20H137V16C137 15.7348 136.895 15.4804 136.707 15.2929C136.52 15.1054 136.265 15 136 15ZM126 27H124V25H126V27ZM126 23H124V21H126V23ZM126 19H124V17H126V19Z" fill="#E6EB6C"/>
                            </svg>
                        </span>
                        <span class="svg-hover">
                            <svg width="159" height="43" viewBox="0 0 159 43" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="159" height="43" fill="#E6EB6C"/>
                            <rect x="2" y="2" width="155" height="39" fill="#E6EB6C" stroke="#E6EB6C" stroke-width="4"/>
                            <path d="M23.111 28.288C22.055 28.288 21.125 28.051 20.321 27.577C19.523 27.103 18.899 26.398 18.449 25.462C17.999 24.526 17.774 23.365 17.774 21.979C17.774 20.587 17.996 19.423 18.44 18.487C18.89 17.551 19.517 16.846 20.321 16.372C21.125 15.892 22.055 15.652 23.111 15.652C24.635 15.652 25.796 16.012 26.594 16.732C27.392 17.452 27.866 18.385 28.016 19.531L24.956 20.062C24.818 19.546 24.599 19.12 24.299 18.784C24.005 18.442 23.609 18.271 23.111 18.271C22.667 18.271 22.274 18.406 21.932 18.676C21.596 18.94 21.335 19.345 21.149 19.891C20.963 20.437 20.87 21.133 20.87 21.979C20.87 22.807 20.966 23.494 21.158 24.04C21.35 24.58 21.614 24.982 21.95 25.246C22.292 25.51 22.679 25.642 23.111 25.642C23.729 25.642 24.191 25.48 24.497 25.156C24.803 24.826 24.956 24.427 24.956 23.959H27.998C27.998 24.889 27.809 25.678 27.431 26.326C27.059 26.968 26.51 27.457 25.784 27.793C25.058 28.123 24.167 28.288 23.111 28.288ZM35.2749 28.288C34.1289 28.288 33.1269 28.048 32.2689 27.568C31.4169 27.082 30.7539 26.368 30.2799 25.426C29.8059 24.478 29.5689 23.311 29.5689 21.925C29.5689 20.503 29.8059 19.33 30.2799 18.406C30.7539 17.476 31.4169 16.786 32.2689 16.336C33.1269 15.88 34.1289 15.652 35.2749 15.652C36.4329 15.652 37.4409 15.889 38.2989 16.363C39.1629 16.837 39.8319 17.539 40.3059 18.469C40.7799 19.399 41.0169 20.551 41.0169 21.925C41.0169 23.335 40.7799 24.514 40.3059 25.462C39.8319 26.404 39.1629 27.112 38.2989 27.586C37.4409 28.054 36.4329 28.288 35.2749 28.288ZM35.2749 25.705C36.1149 25.705 36.7869 25.375 37.2909 24.715C37.7949 24.049 38.0469 23.113 38.0469 21.907C38.0469 20.773 37.7949 19.879 37.2909 19.225C36.7869 18.565 36.1149 18.235 35.2749 18.235C34.4589 18.235 33.7989 18.565 33.2949 19.225C32.7909 19.879 32.5389 20.779 32.5389 21.925C32.5389 23.119 32.7909 24.049 33.2949 24.715C33.7989 25.375 34.4589 25.705 35.2749 25.705ZM43.3062 15.922H47.4282L50.1012 22.366H49.8762L52.5492 15.922H56.5092V28H53.6112V19.405H54.0072L50.9022 26.875H49.0392L45.9522 19.423H46.1862V28H43.3062V15.922ZM59.4939 28V15.922H64.1289C65.5209 15.922 66.6249 16.258 67.4409 16.93C68.2569 17.596 68.6649 18.583 68.6649 19.891C68.6649 21.193 68.2569 22.183 67.4409 22.861C66.6249 23.533 65.5209 23.869 64.1289 23.869H62.3919V28H59.4939ZM62.3919 21.349H64.1289C64.6509 21.349 65.0439 21.205 65.3079 20.917C65.5779 20.623 65.7129 20.281 65.7129 19.891C65.7129 19.495 65.5779 19.15 65.3079 18.856C65.0439 18.562 64.6509 18.415 64.1289 18.415H62.3919V21.349ZM70.5347 28V15.922H75.2507C76.7627 15.922 77.9357 16.27 78.7697 16.966C79.6097 17.656 80.0297 18.583 80.0297 19.747C80.0297 20.887 79.6097 21.802 78.7697 22.492C77.9357 23.176 76.7627 23.518 75.2507 23.518H73.4147V28H70.5347ZM76.8347 28L73.8917 22.168H76.9337L80.6057 28H76.8347ZM73.4147 21.646H74.9267C75.6407 21.646 76.1747 21.499 76.5287 21.205C76.8887 20.905 77.0687 20.524 77.0687 20.062C77.0687 19.582 76.9157 19.189 76.6097 18.883C76.3097 18.571 75.8567 18.415 75.2507 18.415H73.4147V21.646ZM81.5017 28L85.5697 15.922H89.2327L93.0757 28H90.0427L89.3857 25.876H85.2187L84.5617 28H81.5017ZM85.9477 23.743H88.7287L87.3607 19.324L85.9477 23.743ZM94.9155 28V15.922H99.6315C101.144 15.922 102.317 16.27 103.151 16.966C103.991 17.656 104.411 18.583 104.411 19.747C104.411 20.887 103.991 21.802 103.151 22.492C102.317 23.176 101.144 23.518 99.6315 23.518H97.7955V28H94.9155ZM101.216 28L98.2725 22.168H101.315L104.987 28H101.216ZM97.7955 21.646H99.3075C100.022 21.646 100.556 21.499 100.91 21.205C101.27 20.905 101.45 20.524 101.45 20.062C101.45 19.582 101.297 19.189 100.991 18.883C100.691 18.571 100.238 18.415 99.6315 18.415H97.7955V21.646Z" fill="#213140"/>
                            <path d="M136 15H118C117.735 15 117.48 15.1054 117.293 15.2929C117.105 15.4804 117 15.7348 117 16V20H117.893C118.889 20 119.813 20.681 119.973 21.664C120.022 21.951 120.007 22.2453 119.931 22.5261C119.854 22.807 119.717 23.0677 119.529 23.2902C119.341 23.5126 119.107 23.6913 118.843 23.8139C118.579 23.9365 118.291 24 118 24H117V28C117 28.2652 117.105 28.5196 117.293 28.7071C117.48 28.8946 117.735 29 118 29H136C136.265 29 136.52 28.8946 136.707 28.7071C136.895 28.5196 137 28.2652 137 28V24H136C135.709 24 135.421 23.9365 135.157 23.8139C134.893 23.6913 134.659 23.5126 134.471 23.2902C134.283 23.0677 134.146 22.807 134.069 22.5261C133.993 22.2453 133.978 21.951 134.027 21.664C134.187 20.681 135.111 20 136.107 20H137V16C137 15.7348 136.895 15.4804 136.707 15.2929C136.52 15.1054 136.265 15 136 15ZM126 27H124V25H126V27ZM126 23H124V21H126V23ZM126 19H124V17H126V19Z" fill="#213140"/>
                            </svg>
                        </span>
                    </a>
            </p>
            </div>
        `).join('');
    }
});
